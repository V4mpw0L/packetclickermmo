<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Packet Clicker!</title>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover, user-scalable=no, shrink-to-fit=no"
        />
        <meta name="format-detection" content="telephone=no" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />
        <meta name="apple-touch-fullscreen" content="yes" />
        <meta name="mobile-web-app-capable" content="yes" />

        <!-- PWA / SEO / SOCIAL META -->
        <link rel="manifest" href="manifest.json" />
        <meta name="theme-color" content="#161a22" />
        <meta
            name="description"
            content="Packet Clicker ‚Äì Cyberpunk idle clicker MMO for web and mobile. Evolve, earn gems, collect skins, compete and have fun!"
        />
        <meta property="og:title" content="Packet Clicker" />
        <meta
            property="og:description"
            content="Cyberpunk idle MMO game: evolve, earn gems, compete, unlock skins and more!"
        />
        <meta property="og:image" content="src/assets/packet-512.png" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://seusite.com/" />
        <!-- Update to your real site -->
        <link
            rel="icon"
            href="src/assets/packet-32.png"
            sizes="32x32"
            type="image/png"
        />
        <link
            rel="icon"
            href="src/assets/packet-48.png"
            sizes="48x48"
            type="image/png"
        />
        <link
            rel="icon"
            href="src/assets/packet-64.png"
            sizes="64x64"
            type="image/png"
        />
        <link
            rel="icon"
            href="src/assets/packet-512.png"
            sizes="512x512"
            type="image/png"
        />
        <link rel="apple-touch-icon" href="src/assets/packet-512.png" />

        <!-- Custom CSS only - no external dependencies -->
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <!-- Top Navigation Bar -->
        <nav class="top-bar" role="navigation" aria-label="Main navigation">
            <div class="user-info">
                <img
                    id="avatar"
                    src="https://api.dicebear.com/8.x/bottts-neutral/svg?seed=Hacker"
                    alt="Player avatar"
                    draggable="false"
                />
                <span id="player-name">Player</span>
                <span id="vip-badge"></span>
            </div>
            <div class="controls">
                <span id="gem-display">
                    <img
                        src="src/assets/gem.png"
                        alt="Gems"
                        style="
                            height: 1.1rem;
                            width: 1.1rem;
                            vertical-align: middle;
                            display: inline-block;
                        "
                        aria-hidden="true"
                    />
                    <span id="gem-count">0</span>
                </span>
                <button
                    id="open-settings"
                    title="Settings"
                    aria-label="Open settings"
                >
                    ‚öôÔ∏è
                </button>
            </div>
        </nav>

        <!-- Tab Menu Bar -->
        <nav class="menu-bar" role="tablist" aria-label="Game sections">
            <button
                class="tab-btn"
                data-tab="game"
                role="tab"
                aria-label="Game"
                title="Game"
            >
                üïπÔ∏è
            </button>
            <button
                class="tab-btn"
                data-tab="upgrades"
                role="tab"
                aria-label="Upgrades"
                title="Upgrades"
            >
                üõ†Ô∏è
            </button>
            <button
                class="tab-btn"
                data-tab="achievements"
                role="tab"
                aria-label="Achievements"
                title="Achievements"
            >
                üéØ
            </button>
            <button
                class="tab-btn"
                data-tab="shop"
                role="tab"
                aria-label="Shop"
                title="Shop"
            >
                üè¨
            </button>
            <button
                class="tab-btn"
                data-tab="boosts"
                role="tab"
                aria-label="Boosts"
                title="Boosts"
            >
                ‚ö°
            </button>
            <button
                class="tab-btn"
                data-tab="themes"
                role="tab"
                aria-label="Themes"
                title="Themes"
            >
                üé®
            </button>
            <button
                class="tab-btn"
                data-tab="prestige"
                role="tab"
                aria-label="Prestige"
                title="Prestige"
            >
                ‚≠ê
            </button>
            <button
                class="tab-btn"
                data-tab="daily"
                role="tab"
                aria-label="Daily"
                title="Daily"
            >
                üìÖ
            </button>
            <button
                class="tab-btn"
                data-tab="leaderboard"
                role="tab"
                aria-label="Leaderboard"
                title="Leaderboard"
            >
                üèÜ
            </button>
        </nav>

        <!-- Main Content / Tabs -->
        <main id="tab-content" role="main" aria-live="polite"></main>

        <!-- Modals: Profile & Settings -->
        <div id="modal-backdrop" class="modal-backdrop hidden">
            <div
                id="modal"
                class="modal-box hidden"
                role="dialog"
                aria-modal="true"
                tabindex="-1"
                aria-labelledby="modal-title"
            ></div>
        </div>

        <!-- HUD notification (injected by JS) -->

        <footer role="contentinfo">
            <div
                style="
                    display: flex;
                    gap: 0.5rem;
                    align-items: center;
                    justify-content: center;
                    flex-wrap: wrap;
                "
            >
                <span
                    >Packet Clicker &copy; 2025 | Developed by:
                    <a
                        href="https://www.gennisys.com"
                        target="_blank"
                        rel="noopener"
                        style="
                            color: #00ff41;
                            text-decoration: none;
                            font-weight: bold;
                        "
                        >Gennisys</a
                    >
                </span>
                <span
                    id="version-badge"
                    title="App version"
                    style="
                        display: inline-flex;
                        align-items: center;
                        gap: 0.35rem;
                        padding: 0.15rem 0.5rem;
                        border: 1px solid var(--primary-color);
                        color: var(--primary-color);
                        border-radius: 8px;
                        font-weight: 700;
                        font-size: 0.85rem;
                        background: linear-gradient(
                            135deg,
                            var(--bg-secondary),
                            var(--bg-card)
                        );
                        box-shadow: 0 2px 10px var(--shadow-primary);
                    "
                >
                    <span>Version</span><strong id="app-version">0.0.4</strong>
                </span>
            </div>
        </footer>

        <!-- Constants (UMD) -->
        <script src="src/data/constants.js"></script>
        <!-- I18N (UMD) -->
        <script src="src/data/i18n.js"></script>
        <!-- Storage (UMD) -->
        <script src="src/utils/storage.js"></script>
        <!-- Modular helpers (non-invasive) -->
        <script src="src/ui/ui.js"></script>
        <script src="src/logic/bootstrap.js"></script>
        <script>
            (function () {
                try {
                    var v =
                        (window.Packet &&
                            window.Packet.data &&
                            window.Packet.data.APP_VERSION) ||
                        window.APP_VERSION ||
                        (typeof VERSION !== "undefined" ? VERSION : null);
                    if (v) {
                        var el = document.getElementById("app-version");
                        if (el) el.textContent = v;
                        var badge = document.getElementById("version-badge");
                        if (badge) badge.title = "App version " + v;
                    }
                } catch (e) {}
            })();
        </script>

        <!-- Main Game Logic -->
        <script src="main.js"></script>
        <!-- I18N wiring and language pickers -->
        <script>
            (function () {
                // Helper to translate dynamic HTML from render* functions
                function tr(k, p) {
                    try {
                        return window.Packet && window.Packet.i18n
                            ? window.Packet.i18n.t(k, p)
                            : k;
                    } catch (_) {
                        return k;
                    }
                }
                function translateHtml(html) {
                    try {
                        return String(html)
                            .replace(
                                />üéÆ Game</g,
                                ">üéÆ " + tr("tabs.game") + "<",
                            )
                            .replace(
                                />üõ†Ô∏è Upgrades</g,
                                ">üõ†Ô∏è " + tr("tabs.upgrades") + "<",
                            )
                            .replace(
                                />üìÖ Daily Rewards</g,
                                ">üìÖ " + tr("daily.title") + "<",
                            )
                            .replace(
                                />‚ö° Temporary Boosts</g,
                                ">‚ö° " + tr("boosts.title") + "<",
                            )
                            .replace(
                                />‚≠ê Prestige</g,
                                ">‚≠ê " + tr("prestige.title") + "<",
                            )
                            .replace(/Collect Packets/g, tr("buttons.collect"))
                            .replace(
                                /Packets\/Click:/g,
                                tr("labels.packetsPerClick") + ":",
                            )
                            .replace(
                                /Packets\/Sec:/g,
                                tr("labels.packetsPerSec") + ":",
                            )
                            .replace(
                                /Crit Chance:/g,
                                tr("labels.critChance") + ":",
                            )
                            .replace(
                                /Crit Multiplier:/g,
                                tr("labels.critMultiplier") + ":",
                            )
                            .replace(
                                /Available Boosts/g,
                                tr("boosts.available"),
                            )
                            .replace(
                                /Boosts stack with other bonuses for maximum effect!/g,
                                tr("boosts.stackHint"),
                            )
                            .replace(
                                /Need 50,000 packets to prestige/g,
                                tr("prestige.need"),
                            )
                            .replace(
                                /Reset progress for permanent bonuses/g,
                                tr("prestige.resetHint"),
                            );
                    } catch (_) {
                        return html;
                    }
                }
                function applyLang() {
                    // Update navbar/tab button aria-labels and titles
                    function updateNavLabels() {
                        try {
                            var map = {
                                game: "tabs.game",
                                upgrades: "tabs.upgrades",
                                achievements: "tabs.achievements",
                                shop: "tabs.shop",
                                boosts: "tabs.boosts",
                                themes: "tabs.themes",
                                prestige: "tabs.prestige",
                                daily: "daily.title",
                                leaderboard: "tabs.leaderboard",
                            };
                            var i18n = window.Packet && window.Packet.i18n;
                            var buttons =
                                document.querySelectorAll(".menu-bar .tab-btn");
                            buttons.forEach(function (btn) {
                                var tab = btn.getAttribute("data-tab");
                                if (!tab || !map[tab] || !i18n) return;
                                var label = i18n.t(map[tab]);
                                btn.setAttribute("aria-label", label);
                                btn.setAttribute("title", label);
                            });
                            // Settings gear title/aria
                            var settings =
                                document.getElementById("open-settings");
                            if (settings && i18n) {
                                var st = i18n.t("settings.title");
                                settings.setAttribute("title", st);
                                settings.setAttribute("aria-label", st);
                            }
                            // Tablist aria-label for screen readers
                            var tablist = document.querySelector(
                                'nav.menu-bar[role="tablist"]',
                            );
                            if (tablist && i18n) {
                                tablist.setAttribute(
                                    "aria-label",
                                    i18n.t("tabs.game") + " sections",
                                );
                            }
                        } catch (_) {}
                    }
                    try {
                        if (window.Packet && window.Packet.i18n) {
                            window.Packet.i18n.applyLanguageToData();
                        }
                    } catch (_) {}
                    try {
                        typeof updateTopBar === "function" && updateTopBar();
                    } catch (_) {}
                    try {
                        typeof renderTab === "function" && renderTab();
                    } catch (_) {}
                    // Footer label
                    try {
                        var badge = document.getElementById("version-badge");
                        if (badge) {
                            var s = badge.querySelector("span");
                            if (s && window.Packet && window.Packet.i18n) {
                                s.textContent =
                                    window.Packet.i18n.t("labels.version");
                            }
                        }
                    } catch (_) {}
                    // Finally update navbar labels/titles
                    updateNavLabels();
                }
                // Wrap render functions to translate their HTML output
                (function wrapRenders() {
                    var names = [
                        "renderGame",
                        "renderUpgrades",
                        "renderAchievements",
                        "renderShop",
                        "renderLeaderboard",
                        "renderPrestige",
                        "renderDaily",
                        "renderBoosts",
                        "renderThemes",
                    ];
                    names.forEach(function (n) {
                        if (typeof window[n] === "function") {
                            var _orig = window[n];
                            window[n] = function () {
                                var html = _orig.apply(this, arguments);
                                return translateHtml(html);
                            };
                        }
                    });
                })();

                // Inject language select into Settings modal
                (function patchSettings() {
                    if (typeof window.showSettings !== "function") return;
                    var _orig = window.showSettings;
                    window.showSettings = function () {
                        _orig();
                        setTimeout(function () {
                            try {
                                var box = document.querySelector(".modal-box");
                                if (!box || box.querySelector("#lang-select"))
                                    return;
                                var title =
                                    window.Packet && window.Packet.i18n
                                        ? window.Packet.i18n.t("settings.title")
                                        : "Settings";
                                // Replace modal title if needed
                                var h = box.querySelector("h2,h3,h1");
                                if (h && title) h.textContent = title;

                                var wrap = document.createElement("label");
                                wrap.className = "flex items-center mb-2";
                                wrap.innerHTML =
                                    '<span class="mr-2">Language</span>' +
                                    '<select id="lang-select" class="w-full p-2 bg-gray-700 rounded border border-neon-cyan">' +
                                    '<option value="en">English</option>' +
                                    '<option value="pt-br">Portugu√™s (Brasil)</option>' +
                                    '<option value="ru">–†—É—Å—Å–∫–∏–π</option>' +
                                    "</select>";
                                var before =
                                    box.querySelector("#edit-profile-inside") ||
                                    box.firstChild;
                                box.insertBefore(wrap, before);

                                var sel = wrap.querySelector("#lang-select");
                                try {
                                    sel.value =
                                        (window.Packet &&
                                            window.Packet.i18n &&
                                            window.Packet.i18n.getLanguage()) ||
                                        "en";
                                } catch (_) {}
                                sel.onchange = function () {
                                    if (window.Packet && window.Packet.i18n) {
                                        window.Packet.i18n.setLanguage(
                                            this.value,
                                        );
                                        applyLang();
                                    }
                                };
                            } catch (_) {}
                        }, 0);
                    };
                })();

                // Inject language select into Edit Profile modal and persist on Save
                (function patchEditProfile() {
                    if (typeof window.showEditProfile !== "function") return;
                    var _orig = window.showEditProfile;
                    window.showEditProfile = function () {
                        _orig();
                        setTimeout(function () {
                            try {
                                var form =
                                    document.getElementById("profile-form");
                                if (!form || form.querySelector("#lang-select"))
                                    return;
                                var field = document.createElement("label");
                                field.className = "block mb-3";
                                field.innerHTML =
                                    '<span class="block mb-1 font-semibold">Language:</span>' +
                                    '<select id="lang-select" class="w-full p-2 bg-gray-700 rounded border border-neon-cyan">' +
                                    '<option value="en">English</option>' +
                                    '<option value="pt-br">Portugu√™s (Brasil)</option>' +
                                    '<option value="ru">–†—É—Å—Å–∫–∏–π</option>' +
                                    "</select>";
                                var avatarBlock = form.querySelector(".mb-4");
                                form.insertBefore(field, avatarBlock);

                                var sel = field.querySelector("#lang-select");
                                try {
                                    sel.value =
                                        (window.Packet &&
                                            window.Packet.i18n &&
                                            window.Packet.i18n.getLanguage()) ||
                                        "en";
                                } catch (_) {}
                                form.addEventListener(
                                    "submit",
                                    function () {
                                        try {
                                            if (
                                                window.Packet &&
                                                window.Packet.i18n
                                            ) {
                                                window.Packet.i18n.setLanguage(
                                                    sel.value,
                                                );
                                                setTimeout(applyLang, 0);
                                            }
                                        } catch (_) {}
                                    },
                                    { once: true },
                                );
                            } catch (_) {}
                        }, 0);
                    };
                })();

                // React on language changes
                window.addEventListener("packet:i18n:change", function () {
                    applyLang();
                });

                // Initial apply (if stored lang is not English)
                applyLang();
            })();
        </script>

        <!-- PWA: Register Service Worker -->
        <script>
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker
                    .register("service-worker.js")
                    .then(function (reg) {
                        const hasController =
                            !!navigator.serviceWorker.controller;
                        // Only request skipWaiting once per session and only when updating an existing SW
                        const alreadySkipped =
                            sessionStorage.getItem("sw-skip") === "1";
                        if (reg.waiting && hasController && !alreadySkipped) {
                            reg.waiting.postMessage({ type: "SKIP_WAITING" });
                            sessionStorage.setItem("sw-skip", "1");
                        }

                        // Listen for a new worker and activate it once per session when updating
                        reg.addEventListener("updatefound", function () {
                            const newWorker = reg.installing;
                            if (!newWorker) return;
                            newWorker.addEventListener(
                                "statechange",
                                function () {
                                    if (
                                        newWorker.state === "installed" &&
                                        hasController &&
                                        sessionStorage.getItem("sw-skip") !==
                                            "1"
                                    ) {
                                        newWorker.postMessage({
                                            type: "SKIP_WAITING",
                                        });
                                        sessionStorage.setItem("sw-skip", "1");
                                    }
                                },
                            );
                        });

                        // Update check disabled to avoid redundant updates
                    });

                // Guarded one-time reload when the new service worker takes control
                navigator.serviceWorker.addEventListener(
                    "controllerchange",
                    function () {
                        if (sessionStorage.getItem("sw-reloaded") === "1")
                            return;
                        sessionStorage.setItem("sw-reloaded", "1");
                        window.location.reload();
                    },
                );
            }
        </script>
    </body>
</html>
