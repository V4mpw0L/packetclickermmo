<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Upload Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .test-section {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }

        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .pass {
            background-color: #0f4c3a;
            border: 1px solid #10b981;
            color: #10b981;
        }

        .fail {
            background-color: #4c1d1d;
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        .info {
            background-color: #1e3a8a;
            border: 1px solid #3b82f6;
            color: #3b82f6;
        }

        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background-color: #2563eb;
        }

        input[type="file"] {
            margin: 10px 0;
            padding: 8px;
            background-color: #374151;
            border: 1px solid #6b7280;
            border-radius: 4px;
            color: white;
        }

        .avatar-preview {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 2px solid #3b82f6;
            object-fit: cover;
            margin: 10px;
        }

        .size-info {
            font-family: monospace;
            font-size: 12px;
            color: #9ca3af;
            margin: 5px 0;
        }

        .progress {
            background-color: #374151;
            border-radius: 4px;
            overflow: hidden;
            height: 8px;
            margin: 10px 0;
        }

        .progress-bar {
            background-color: #10b981;
            height: 100%;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <h1>üñºÔ∏è Avatar Upload Fix Test</h1>
    <p>This page tests the fixes for custom avatar uploads to ensure they work properly with Firebase Storage and don't create huge data URLs.</p>

    <div class="test-section">
        <h2>üìã Test Results</h2>
        <div id="test-results"></div>
        <button onclick="runAllTests()">Run All Tests</button>
    </div>

    <div class="test-section">
        <h2>üîß Avatar Upload Test</h2>
        <p>Upload an image to test the compression and validation:</p>
        <input type="file" id="avatar-upload" accept="image/*">
        <div id="upload-info"></div>
        <div id="avatar-preview"></div>
        <button onclick="testAvatarGeneration()">Generate Test Avatar</button>
    </div>

    <div class="test-section">
        <h2>üìä Performance Metrics</h2>
        <div id="performance-metrics"></div>
    </div>

    <script>
        let testResults = [];

        function addTestResult(name, passed, details) {
            testResults.push({ name, passed, details });
            updateTestDisplay();
        }

        function updateTestDisplay() {
            const container = document.getElementById('test-results');
            container.innerHTML = testResults.map(test => `
                <div class="test-result ${test.passed ? 'pass' : 'fail'}">
                    <strong>${test.passed ? '‚úÖ' : '‚ùå'} ${test.name}</strong>
                    <div class="size-info">${test.details}</div>
                </div>
            `).join('');
        }

        function runAllTests() {
            testResults = [];

            // Test 1: Canvas API availability
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                addTestResult('Canvas API Available', !!ctx, 'Canvas context created successfully');
            } catch (e) {
                addTestResult('Canvas API Available', false, `Error: ${e.message}`);
            }

            // Test 2: FileReader API availability
            try {
                const reader = new FileReader();
                addTestResult('FileReader API Available', !!reader, 'FileReader instance created successfully');
            } catch (e) {
                addTestResult('FileReader API Available', false, `Error: ${e.message}`);
            }

            // Test 3: Image compression test
            testImageCompression();

            // Test 4: Data URL validation test
            testDataUrlValidation();

            // Test 5: Filename generation test
            testFilenameGeneration();
        }

        function testImageCompression() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Create a test pattern
            canvas.width = 256;
            canvas.height = 256;

            // Draw a test pattern
            for (let i = 0; i < 256; i++) {
                for (let j = 0; j < 256; j++) {
                    const r = Math.sin(i * 0.1) * 127 + 128;
                    const g = Math.sin(j * 0.1) * 127 + 128;
                    const b = Math.sin((i + j) * 0.1) * 127 + 128;
                    ctx.fillStyle = `rgb(${r},${g},${b})`;
                    ctx.fillRect(i, j, 1, 1);
                }
            }

            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            const sizeKB = Math.round(dataUrl.length / 1024);
            const passed = dataUrl.length < 200000; // 200KB limit

            addTestResult('Image Compression', passed,
                `Test image size: ${sizeKB}KB (${dataUrl.length} bytes). Limit: 200KB`);
        }

        function testDataUrlValidation() {
            const validDataUrl = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwCdABmX/9k=';
            const invalidDataUrl = 'data:text/plain;base64,invalid';
            const tooLargeDataUrl = 'data:image/jpeg;base64,' + 'A'.repeat(250000);

            const validMatch = validDataUrl.match(/^data:image\/(png|jpg|jpeg|gif|webp);base64,/);
            const invalidMatch = invalidDataUrl.match(/^data:image\/(png|jpg|jpeg|gif|webp);base64,/);

            let passed = 0;
            let total = 3;

            if (validMatch) passed++;
            if (!invalidMatch) passed++;
            if (tooLargeDataUrl.length > 200000) passed++;

            addTestResult('Data URL Validation', passed === total,
                `Passed ${passed}/${total} validation tests`);
        }

        function testFilenameGeneration() {
            function generateTestFilename(id) {
                const safeId = String(id || 'test').replace(/[^a-zA-Z0-9]/g, '').substring(0, 8);
                const shortTimestamp = Date.now().toString(36);
                const randomSuffix = Math.random().toString(36).substring(2, 6);
                return `${safeId}_${shortTimestamp}_${randomSuffix}.png`;
            }

            const testIds = ['dev_kb7oh34hr5g_mgpsrkrd', 'user123!@#', 'a'.repeat(50)];
            let allValid = true;
            let details = [];

            testIds.forEach(id => {
                const filename = generateTestFilename(id);
                const isValid = filename.length < 50 && /^[a-zA-Z0-9_.]+$/.test(filename);
                if (!isValid) allValid = false;
                details.push(`${id.substring(0, 20)}... ‚Üí ${filename}`);
            });

            addTestResult('Filename Generation', allValid,
                `Generated filenames:\n${details.join('\n')}`);
        }

        // Avatar upload functionality
        document.getElementById('avatar-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const infoDiv = document.getElementById('upload-info');
            const previewDiv = document.getElementById('avatar-preview');

            infoDiv.innerHTML = `
                <div class="info">Processing file: ${file.name}</div>
                <div class="size-info">Original size: ${Math.round(file.size / 1024)}KB</div>
                <div class="progress"><div class="progress-bar" id="progress-bar"></div></div>
            `;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                infoDiv.innerHTML += '<div class="test-result fail">‚ùå Invalid file type</div>';
                return;
            }

            // Validate file size
            if (file.size > 2 * 1024 * 1024) {
                infoDiv.innerHTML += '<div class="test-result fail">‚ùå File too large (max 2MB)</div>';
                return;
            }

            // Process image
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = function() {
                // Update progress
                document.getElementById('progress-bar').style.width = '50%';

                // Resize image
                const maxSize = 256;
                let { width, height } = img;

                if (width > height) {
                    if (width > maxSize) {
                        height = (height * maxSize) / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width = (width * maxSize) / height;
                        height = maxSize;
                    }
                }

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                // Convert to compressed data URL
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                const compressedSize = Math.round(dataUrl.length / 1024);

                // Update progress
                document.getElementById('progress-bar').style.width = '100%';

                // Display results
                const sizeReduction = Math.round((1 - dataUrl.length / file.size) * 100);
                const withinLimit = dataUrl.length <= 100000;

                infoDiv.innerHTML += `
                    <div class="test-result ${withinLimit ? 'pass' : 'fail'}">
                        ${withinLimit ? '‚úÖ' : '‚ùå'} Compressed size: ${compressedSize}KB
                    </div>
                    <div class="size-info">
                        Size reduction: ${sizeReduction}%<br>
                        Dimensions: ${width}x${height}<br>
                        Data URL length: ${dataUrl.length} bytes
                    </div>
                `;

                // Show preview
                previewDiv.innerHTML = `<img src="${dataUrl}" class="avatar-preview" alt="Avatar preview">`;
            };

            const reader = new FileReader();
            reader.onload = function(ev) {
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        });

        function testAvatarGeneration() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = 256;
            canvas.height = 256;

            // Generate a random avatar pattern
            const hue = Math.random() * 360;
            const gradient = ctx.createRadialGradient(128, 128, 0, 128, 128, 128);
            gradient.addColorStop(0, `hsl(${hue}, 70%, 60%)`);
            gradient.addColorStop(1, `hsl(${hue + 60}, 50%, 30%)`);

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 256, 256);

            // Add some geometric patterns
            ctx.fillStyle = `hsl(${hue + 120}, 80%, 80%)`;
            ctx.beginPath();
            ctx.arc(128, 128, 64, 0, Math.PI * 2);
            ctx.fill();

            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            const size = Math.round(dataUrl.length / 1024);

            document.getElementById('avatar-preview').innerHTML =
                `<img src="${dataUrl}" class="avatar-preview" alt="Generated avatar">`;

            document.getElementById('upload-info').innerHTML = `
                <div class="test-result pass">‚úÖ Generated test avatar</div>
                <div class="size-info">Size: ${size}KB (${dataUrl.length} bytes)</div>
            `;
        }

        // Performance monitoring
        function updatePerformanceMetrics() {
            const metrics = document.getElementById('performance-metrics');
            const now = performance.now();

            metrics.innerHTML = `
                <div class="size-info">
                    Page load time: ${Math.round(now)}ms<br>
                    Memory usage: ${navigator.deviceMemory ? navigator.deviceMemory + 'GB' : 'Unknown'}<br>
                    User agent: ${navigator.userAgent.substring(0, 80)}...
                </div>
            `;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updatePerformanceMetrics();
            runAllTests();
        });
    </script>
</body>
</html>
